service: pocz-api
frameworkVersion: '3'
useDotenv: true
variablesResolutionMode: 20210326

resources:
  Description: The main stack for ${env:PROJECT_NAME}

package:
  individually: true

plugins:
  - serverless-bundle
  - serverless-offline
  - serverless-dotenv-plugin
  - serverless-domain-manager
  - serverless-sequelize-migrations
  - serverless-iam-roles-per-function

custom:
  bundle:
    ignorePackages:
      - pg-native
    forceExclude:
      - pg
      - pg-hstore
      - dotenv
      - sequelize

  customDomain:
    domainName: ${env:PROJECT_API_DOMAIN}
    basePath: ''
    stage: ${self:provider.stage}
    createRoute53Record: true
    endpointType: 'regional'
    securityPolicy: tls_1_2

provider:
  name: aws
  runtime: nodejs14.x
  region: us-east-1
  profile: default
  stage: ${opt:stage, "development"}
  lambdaHashingVersion: 20201221
  environment:
    NODE_ENV: ${self:provider.stage}
    JWT_SECRET: ${env:JWT_SECRET}
    PROJECT_NAME: ${env:PROJECT_NAME}
    PROJECT_APP_URL: ${env:PROJECT_APP_URL}
  tracing:
    lambda: true
  iamRoleStatements:
    - Effect: Allow
      Action:
        - xray:PutTraceSegments
        - xray:PutTelemetryRecords
      Resource: '*'

layers:
  pg:
    path: layers/postgre
    description: 'PostgreSQL Dependencies'
  dotenvPgSequelize:
    package:
      artifact: layers/dotenv_pg_sequelize/DotenvPgSequelize.zip
    description: 'dotenv 10.0.0 pg 8.7.1 pg-hstore 2.3.4 sequelize 6.7.0'

functions:
  healthCheck:
    handler: services/test-db/handler.healthCheck
    events:
      - http:
          path: /
          method: get
          cors: true
    layers:
      - !Ref PgLambdaLayer
      - !Ref DotenvPgSequelizeLambdaLayer

  auth-verify:
    handler: services/auth-api/verify.handler

  auth:
    handler: services/auth-api/handler.handler
    events:
      - http:
          path: /auth/register
          method: post
          cors: true
      - http:
          path: /auth/login
          method: post
          cors: true
      - http:
          path: /auth/forgot-password
          method: post
          cors: true
      - http:
          path: /auth/forgot-password-code
          method: post
          cors: true
      - http:
          path: /auth/change-password
          method: post
          cors: true
      - http:
          path: /auth/refresh-token
          method: post
          cors: true
      - http:
          path: /auth/me
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
    layers:
      - !Ref PgLambdaLayer
      - !Ref DotenvPgSequelizeLambdaLayer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - 'ses:SendEmail'
          - 'ses:SendRawEmail'
        Resource: '*'

  subscriptions:
    handler: services/subscriptions-api/handler.handler
    events:
      - http:
          path: /subscriptions
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /subscriptions/plans
          method: post
          cors: true
      - http:
          path: /subscriptions/payments
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /subscriptions/credit-cards
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
    layers:
      - !Ref PgLambdaLayer
      - !Ref DotenvPgSequelizeLambdaLayer

  places:
    handler: services/places-api/handler.handler
    events:
      - http:
          path: /places
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /places/get/{id}
          method: post
          request:
            parameters:
              querystrings:
                id: true
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /places/create
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /places/delete/{id}
          method: post
          request:
            parameters:
              querystrings:
                id: true
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /places/update/{id}
          method: post
          request:
            parameters:
              querystrings:
                id: true
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /places/count
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /places/active/{id}
          method: post
          request:
            parameters:
              querystrings:
                id: true
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /places/managers/{id}
          method: post
          request:
            parameters:
              querystrings:
                id: true
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /places/employees/{id}
          method: post
          request:
            parameters:
              querystrings:
                id: true
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
    layers:
      - !Ref PgLambdaLayer
      - !Ref DotenvPgSequelizeLambdaLayer

  # TODO: Lambda to handle the avatar image
  profiles:
    handler: services/profiles-api/handler.handler
    events:
      - http:
          path: /profiles
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /profiles/create
          method: post
          request:
            parameters:
              querystrings:
                id: true
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
    layers:
      - !Ref PgLambdaLayer
      - !Ref DotenvPgSequelizeLambdaLayer

  members:
    handler: services/members-api/handler.handler
    events:
      - http:
          path: /members
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /members/list
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /members/get/{id}
          method: post
          request:
            parameters:
              querystrings:
                id: true
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /members/create
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /members/invites
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /members/invites/code/{code}
          method: post
          request:
            parameters:
              querystrings:
                code: true
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /members/invites/create
          method: post
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /members/invites/send/{id}
          method: post
          request:
            parameters:
              querystrings:
                id: true
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
      - http:
          path: /members/invites/delete/{id}
          method: post
          request:
            parameters:
              querystrings:
                id: true
          cors: true
          authorizer:
            name: auth-verify
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 3600
    layers:
      - !Ref PgLambdaLayer
      - !Ref DotenvPgSequelizeLambdaLayer
    iamRoleStatements:
      - Effect: Allow
        Action:
          - 'ses:SendEmail'
          - 'ses:SendRawEmail'
        Resource: '*'
